# 星舰语义理解与执行逻辑审计报告 (当前状态)

本文档提供了星舰 Bot 如何处理自然语言、确定意图以及执行船坞工具的技术基准。

## 1. 意图路由层 (Routing Layer - `router.py`)
系统使用**双阶分流 (Dual-Stage Triage)** 机制来决定一条消息属于 LCARS（计算机）还是标准聊天。

| 阶段 | 机制 | 触发条件 | 置信度 |
|---|---|---|---|
| **手动指令** | 正则表达式 | `进入计算机模式`, `Exit computer mode` | 1.0 |
| **唤醒词** | 正则表达式 | `Computer`, `计算机`, `电脑` (开头) | 0.95 |
| **动词匹配** | 列表匹配 | `报告`, `查询`, `锁定`, `同步` (开头) | 0.85 |
| **模式锁定** | 状态保持 | 现有的活动会话 (TTL: 180s) | 0.75 |
| **AI 判定** | AI 模型 | 模糊意图 (0.5 < 置信度 < 0.8) | 动态 |

## 2. 代理执行循环 (Agentic Loop - `dispatcher.py`)
一旦确认“计算机”意图，**Liquid Agent Matrix (流体代理矩阵)** 开始运行。

- **迭代次数**: 每次用户请求最多迭代 3 次。
- **上下文注入**: 
    - 用户档案 (军衔、权限等级)。
    - 会话历史 (最近 8 轮对话)。
    - ODN 快照 (当前舰船状态及各项指标)。
- **执行流程**: 
    1. **规划**: LLM 生成工具链或直接回复。
    2. **执行**: 串行执行工具（例如：`get_status`, `execute_engagement`）。
    3. **综合**: 如果调用了工具，最后的综合步骤会将工具输出合并为自然语言报告。

## 3. 自愈与调度机制 (Self-Healing Dispatch - `dispatcher.py`)
专为处理 AI 幻觉和微小参数不匹配而设计的安全层。

- **语义映射**: 硬编码桥接（例如：`fire_phasers` -> `tactical_execute`）。
- **模糊匹配**: 使用 `difflib` 搜索（阈值：0.5）以修正工具名中的拼写错误。
- **参数压缩**: 动态签名过滤，并将多余的 AI 参数“压缩”到主要查询字段中。

## 4. 船坞工具集 (Shipyard Toolset - `tools.py`)
所有功能调用的中央注册表。
- **ADS 网关**: `tactical_execute`, `eng_execute`, `ops_execute`, `sci_execute`。
- **日志情报**: `analyze_tactical_situation`, `get_mission_logs`。
- **系统诊断**: `get_status`, `get_subsystem_status`。

---

> [!IMPORTANT]
> **已识别的弱点**: 
> 1. 幻觉映射仍处于被动状态（依赖语义映射表）。 
> 2. 迭代限制 (3次) 可能会在复杂的多步诊断中中断。
> 3. 意图检测过于依赖前缀匹配。
